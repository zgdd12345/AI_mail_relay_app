# Changelog

## [未发布] - 2025-10-30

### 新增功能
- ✨ **单篇论文独立处理**：每篇论文单独调用 LLM 生成摘要，避免 token 限制和输出截断
- ✨ **层级化细分领域**：为每篇论文生成层级化的研究领域（如：计算机视觉 → 图像分割 → 道路分割）
- ✨ **可折叠邮件设计**：基本信息和 AI 详细摘要默认折叠，大幅节省邮件空间
- ✨ 添加"工作内容"字段：在基本信息中用一句话总结论文核心工作（不超过100字）
- ✨ 服务器部署支持：完整的一键部署脚本和定时任务配置
- ✨ Cron 定时任务设置：支持自定义运行时间，默认每天 11:00、12:00、13:00（北京时间）

### 功能改进
- 🔧 **智能邮件发送**：系统现在会在以下情况下跳过邮件发送，避免发送空邮件
  - 没有找到相关的 arXiv 邮件
  - 没有解析出任何论文
  - 过滤后没有 AI 相关论文
  - 去重后没有唯一论文
- 🎨 **邮件视觉统一优化**：
  - 论文标题和序号合并为一行，节省空间
  - 基本信息和 AI 摘要使用统一的紫色渐变折叠按钮
  - 工作内容和细分领域使用统一的淡蓝色渐变背景
  - 整体空间利用率提升约 40-50%
- 📊 **LLM 处理优化**：
  - 每篇论文单独处理，附带处理进度日志
  - 单篇失败不影响其他论文
  - 自动提取细分领域和工作内容
- 📝 日志增强：添加更详细的日志信息，便于调试和监控

### 部署相关
- 📦 `deploy.sh` - 一键部署脚本，自动配置环境（已优化，移除重复安装）
- ⏰ `setup_cron.sh` - 交互式 Cron 定时任务设置
- 🏃 `run.sh` - 运行脚本，自动记录日志并清理旧日志
- 🔍 `diagnose.sh` - 网络诊断脚本，检测 IMAP/SMTP 连接
- 📖 `DEPLOY.md` - 完整的部署文档
- 📖 `TROUBLESHOOTING.md` - 故障排查指南
- 📖 `QUICKSTART_SERVER.md` - 服务器快速修复指南
- 📄 `requirements.txt` - Python 依赖列表（已同步到 pyproject.toml）
- 📋 `.env.example` - 环境变量配置模板

### 邮件格式优化
**邮件正文结构（默认状态）**：
```
📚 每日 arXiv AI 论文摘要

论文 1 | [标题]
├─ 💡 工作内容：一句话总结
├─ 📍 细分领域：一级领域 → 二级领域 → 三级领域
├─ 📋 基本信息 (点击展开/收起) ▼  ← 默认折叠
└─ 🤖 AI 详细摘要 (点击展开/收起) ▼  ← 默认折叠

论文 2 | ...
```

**展开基本信息后**：
```
论文 1 | [标题]
├─ 💡 工作内容：...
├─ 📍 细分领域：...
├─ 📋 基本信息 (点击展开/收起) ▲  ← 已展开
│  ├─ arXiv ID: xxx
│  ├─ 作者: xxx
│  ├─ 单位/备注: xxx
│  ├─ 研究领域: xxx
│  └─ 论文链接: xxx
└─ 🤖 AI 详细摘要 (点击展开/收起) ▼
```

**附件格式**（Markdown）：
- 基本信息（arXiv ID、作者、单位、领域、链接）
- 原始英文摘要

### Bug 修复
- 🐛 修复 arXiv 邮件解析器，支持 `\\` 标记的摘要格式
- 🐛 修复环境变量加载问题，添加 `python-dotenv` 支持
- 🐛 提取 arXiv ID 和作者单位信息
- 🐛 修复依赖配置：将 `python-dotenv` 从可选依赖改为必需依赖
- 🐛 优化部署脚本：移除重复的依赖安装步骤

### 代码优化
- 🎯 **LLM 处理架构重构**：
  - 新增 `summarize_single_paper()` 方法处理单篇论文
  - 修改 `summarize_papers()` 为循环调用单篇处理
  - 添加 `_extract_paper_metadata()` 方法提取元数据
- 🔄 **Prompt 优化**：
  - 为单篇论文设计专用 prompt
  - 要求输出细分领域（层级化格式）
  - 要求输出工作内容（一句话总结）
  - 提供丰富的领域示例引导 LLM
- 📊 日志优化：
  - 添加论文处理进度日志
  - 日志自动清理：保留最近 30 天
  - 运行脚本添加智能错误分类

### 文档更新
- 📚 新增 `DEPLOY.md` - 服务器部署完整指南
- 📚 新增 `deploy/README.md` - 部署脚本说明
- 📚 更新 `README.md` - 添加部署和定时任务说明
- 📚 新增 `CHANGELOG.md` - 变更日志

---

## 使用说明

### 本地开发
```bash
# 安装依赖
pip install -e .

# 测试运行（处理前 3 篇论文）
python test_limited.py

# 完整运行
python -m ai_mail_relay.main
```

### 服务器部署
```bash
# 1. 一键部署
./deploy/deploy.sh

# 2. 配置环境变量
vim .env

# 3. 设置定时任务
./deploy/setup_cron.sh

# 4. 查看日志
tail -f logs/cron.log
```

### 定时任务管理
```bash
# 查看当前任务
crontab -l

# 修改运行时间
./deploy/setup_cron.sh

# 手动运行测试
./deploy/run.sh
```

---

## 技术栈

- **Python 3.10+**
- **httpx** - HTTP 客户端（LLM API 调用）
- **python-dotenv** - 环境变量管理
- **标准库** - imaplib, smtplib, email, re, logging

## 支持的 LLM 提供商

- ✅ OpenAI (GPT-4, GPT-4o, GPT-4o-mini)
- ✅ DeepSeek (deepseek-chat)
- ✅ Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Haiku)
- ✅ 阿里千问 (Qwen Plus, Qwen Turbo, Qwen Max)
- ✅ 字节火山豆包 (ByteDance Ark)

## 贡献者

- 主要开发：使用 Claude Code 辅助开发

---

## 下一步计划

- [ ] 添加单元测试
- [ ] 支持更多邮件过滤选项
- [ ] 添加 Web UI 配置界面
- [ ] 支持数据库存储历史记录
- [ ] 支持多语言摘要
- [ ] 添加邮件模板自定义功能
